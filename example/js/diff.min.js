var Diff={};Diff.cloneObj=function(e){if(null===e||"object"!=typeof e)return e;var f=e.constructor();for(var n in e)f[n]=Diff.cloneObj(e[n]);return f},Diff.get=function(e,f,n){n="undefined"==typeof n?!0:n;var t={};if("undefined"==typeof f)return t=Diff.getChangeObj(e,void 0,n),e=[],t;if("undefined"==typeof e)return t=Diff.getChangeObj(void 0,f,n),e=f,t;n=!0,Array.isArray(e)&&(n=!1);var i,a,r,d;if(Array.isArray(e))a=e.length,r=f.length,i=a>r?a:r;else{var s=Object.keys(e),c=Object.keys(f);a=s.length,r=c.length,d=$.unique(s.concat(c)),i=d.length}for(var l,o,y=[],p={},u=0;i>u;u++)if(l=n?d[u]:u,_.isEqual(e[l],f[l])){if($.isEmptyObject(p)){y.push(l);continue}o=Diff.checkSaved(t,p,e,f,y),e=o.oldData,t=o.ret,p=o.saved,i=o.leng,d=o.keys,y=o.alreadyInUse,u+=o.kCha-1}else{if(n)"object"==typeof e[l]?t[l]=Diff.get(e[l],f[l],n):(t[l]=Diff.getChangeObj(e[l],f[l],n),e[l]=f[l]);else{if($.isEmptyObject(p)&&"undefined"==typeof f[u]){t[u]=Diff.getChangeObj(e[u],void 0,n),e[u]=[];continue}var h=Diff.findObj(e[u],f,y);if(-1==h){if(!$.isEmptyObject(p)&&(o=Diff.checkSaved(t,p,e,f,y),e=o.oldData,t=o.ret,p=o.saved,i=o.leng,d=o.keys,y=o.alreadyInUse,u+=o.kCha,u>=i))continue;"object"==typeof e[u]?t[u]=Diff.get(e[u],f[u],n):(t[u]=Diff.getChangeObj(e[l],f[l],n),e[l]=f[l]);continue}y.push(h),p[u]=h-u}u==i-1&&($.isEmptyObject(p)||(o=Diff.checkSaved(t,p,e,f,y),e=o.oldData,t=o.ret,p=o.saved,i=o.leng,d=o.keys,y=o.alreadyInUse,u+=o.kCha))}return t},Diff.getChangeObj=function(e,f,n){return"undefined"==typeof e?{diffType:"added",typeObj:n,newV:f}:"undefined"==typeof f?{diffType:"deleted",typeObj:n,oldV:e}:{diffType:"changed",oldV:e,typeObj:n,newV:f}},Diff.checkSaved=function(e,f,n,t,i){for(var a=Object.keys(f),r=-Number.MAX_VALUE,d=0,s=0,c=0,l=0;l<a.length;l++){var o=a[l];f[o]>r?(r=f[o],d=1):f[o]==r&&d++}if(a.length==d)if(r>0)for(l=a[0];l<parseInt(a[0])+r;l++)e[l]={diffType:"added",typeObj:!1,newV:t[l]},n.splice(parseInt(l),0,t[l]),c++;else for(l=parseInt(a[0])+r;l<a[0];l++)e[l]={diffType:"deleted",typeObj:!1,oldV:n[l]},n.splice(parseInt(l)-s,1),s++;else{var y=!1;for(l=0;l<a.length;l++){var p=parseInt(a[l]);if(f[p]<r)if(-1===i.indexOf(p+r)&&_.isEqual(n[p],t[p+r]))i.push(p+r),f[p]=r,y=!0;else for(var u=0;u<a.length;u++){var h=a[u];e[h]=Diff.getChangeObj(n[h],t[h],!1),n[h]=t[h]}}if(y)return Diff.checkSaved(e,f,n,t,i)}a=[];var b,g,v;if(Array.isArray(n))g=n.length,v=t.length,b=g>v?g:v;else{var j=Object.keys(n),O=Object.keys(t);g=j.length,v=O.length,a=$.unique(j.concat(O)),b=a.length}var D={oldData:n,ret:e,saved:{},keys:a,leng:b,kCha:c-s,alreadyInUse:i};return D},Diff.toHTML=function(e,f,n,t,i){t="undefined"==typeof t?"":t,i="undefined"==typeof i?[0,0]:i;var a,r,d;a=!0,r=Object.keys(f),d=r.length;for(var s=0,c=!1,l=0;d>l;l++){var o=r[l];if(parseInt(o)==o?(c||(i[0]=i[1]),i[1]=parseInt(o),c=!0):(""===t&&0===i[1]?(t=o,e=e.find("."+t)):parseInt(o)!=o&&(t+="_"+o,e=e.find("."+t)),e=e.slice(i[1]*n.usage[t],(i[1]+1)*n.usage[t])),"diffType"in f[o])switch(f[o].diffType){case"changed":e.text(f[o].newV),s=0;break;case"added":f[o].typeObj||(Mustache.setCache(t+"_tmpl",n.partials[t][i[0]]),e.find("."+t+"-inner").eq(i[1]).before(Mustache.render(t+"_tmpl",f[o].newV))),s=0;break;case"deleted":f[o].typeObj||(e.find("."+t+"-inner").eq(i[1]-s).remove(),s++)}else Diff.toHTML(e,f[o],n,t,i),s=0}},Diff.combine=function(e,f){var n,t,i;n=!0,t=Object.keys(f),i=t.length;for(var a=0,r=0;i>r;r++){var d=t[r];if("diffType"in f[d])switch(f[d].diffType){case"changed":e[d]=f[d].newV,a=0;break;case"added":f[d].typeObj?e[d]=f[d].newV:e.splice(d,0,f[d].newV),a=0;break;case"deleted":f[d].typeObj?delete e[d]:(e.splice(d-a,1),a++)}else Diff.combine(e[d],f[d]),a=0}return e},Diff.findObj=function(e,f,n,t){t="undefined"==typeof t?0:t;for(var i=-1,a=t;a<f.length;a++)if(-1==n.indexOf(a)&&_.isEqual(e,f[a])){i=a;break}return i};